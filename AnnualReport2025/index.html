<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å¹´åº¦é˜…è¯»</title>
    <meta name="referrer" content="no-referrer">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app" class="main-container">
        <div class="input-group">
            <input class="search-input" v-model="query" @keyup.enter="searchBook" placeholder="è¾“å…¥ä¹¦åæœç´¢ï¼Œå›è½¦ç¡®è®¤">
            <button class="btn-search" @click="searchBook" :disabled="loading">
                {{ loading ? '...' : 'ğŸ”' }}
            </button>

            <button class="btn-upload">
                ğŸ“‚
                <input type="file" accept="image/*" @change="handleFileUpload">
            </button>

            <button class="btn-export" @click="exportImage" :disabled="exporting">
                {{ exporting ? 'ç”Ÿæˆä¸­...' : 'ğŸ–¼ï¸' }}
            </button>
        </div>

        <!-- ğŸ“¸ Poster Area Start -->
        <div id="poster" class="poster">
            <header class="header">
                <div class="title-container">
                    <div class="title">2025 Reading Recap</div>
                    <div class="username-line">
                        <span class="at-name">@{{ username || 'YourName' }}</span>
                        <input type="text" v-model="username" placeholder="è¾“å…¥ä½ çš„åå­—" class="name-input"
                            data-html2canvas-ignore>
                    </div>
                </div>
            </header>

            <div class="waterfall-wrap">
                <div class="waterfall">
                    <div v-for="(book, index) in myBooks" :key="book.id" class="book-card">
                        <!-- Delete button is hidden during export via CSS or logic if needed, but CSS hover handles it for UI -->
                        <div class="delete-btn" @click="removeBook(index)" data-html2canvas-ignore>Ã—</div>
                        <img :src="book.cover" referrerPolicy="no-referrer" crossorigin="anonymous"
                            @error="handleImageError">
                        <!-- Book info deleted as per request -->
                    </div>
                </div>
            </div>

            <footer class="poster-footer">
                <div class="footer-left">2025 Reading Recap</div>
                <div class="footer-right">@{{ username || 'YourName' }} Â· {{ myBooks.length }} books</div>
            </footer>
        </div>
        <!-- ğŸ“¸ Poster Area End -->

        <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>é€‰æ‹©ç‰ˆæœ¬</h3>
                    <button class="close-btn" @click="showModal = false">Ã—</button>
                </div>
                <div class="search-results-list">
                    <div v-for="item in searchResults" :key="item.cover" class="result-item" @click="selectBook(item)">
                        <img :src="item.cover" referrerPolicy="no-referrer" @error="handleImageError">
                        <div class="result-title">{{ item.title }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                const query = ref('');
                const loading = ref(false);
                const exporting = ref(false);
                const myBooks = ref([]);
                const searchResults = ref([]);
                const showModal = ref(false);
                const username = ref(''); // Default empty or user can enter

                const WORKER_URL = 'https://falling-sun-969d.sparrowz0116.workers.dev/';

                const searchBook = async () => {
                    if (!query.value.trim()) return;
                    loading.value = true;

                    try {
                        const response = await fetch(`${WORKER_URL}?q=${encodeURIComponent(query.value)}`);
                        const data = await response.json();

                        if (data && data.length > 0) {
                            searchResults.value = data;
                            showModal.value = true;
                        } else {
                            alert('æ²¡æœ‰æ‰¾åˆ°è¿™æœ¬ä¹¦ï¼Œè¯•ç€æ¢ä¸ªå…³é”®è¯ï¼ˆå¯ä»¥è¯•ä¸€ä¸‹å‰¯æ ‡é¢˜æˆ–åŸä½œåï¼‰ï¼Œæˆ–è€…ç›´æ¥ä¸Šä¼ å›¾ç‰‡å§ï¼');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('æœç´¢å‡ºé”™äº†');
                    } finally {
                        loading.value = false;
                    }
                };

                const selectBook = (bookItem) => {
                    myBooks.value.push({
                        id: Date.now(),
                        title: bookItem.title,
                        cover: bookItem.cover
                    });
                    showModal.value = false;
                    query.value = '';
                    searchResults.value = [];
                };

                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        myBooks.value.push({
                            id: Date.now(),
                            title: 'è‡ªå®šä¹‰ä¸Šä¼ ',
                            cover: e.target.result
                        });
                    };
                    reader.readAsDataURL(file);
                    event.target.value = '';
                };

                const removeBook = (index) => {
                    myBooks.value.splice(index, 1);
                };

                const handleImageError = (e) => {
                    const img = e.target;
                    const currentSrc = img.src;

                    if (currentSrc.includes('/l/public/')) {
                        img.src = currentSrc.replace('/l/public/', '/s/public/');
                    }
                    else {
                        img.src = 'https://via.placeholder.com/150x220?text=No+Cover';
                    }
                    img.onerror = null;
                };

                // ğŸŸ¢ å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½
                const exportImage = async () => {
                    if (myBooks.value.length === 0) {
                        alert('å…ˆåŠ å‡ æœ¬ä¹¦å†å¯¼å‡ºå§~');
                        return;
                    }
                    exporting.value = true;

                    await nextTick();

                    // è·å–è¦æˆªå›¾çš„åŒºåŸŸ
                    const element = document.getElementById('poster');

                    // ä¿å­˜åŸæœ‰æ ·å¼
                    const originalPadding = element.style.padding;
                    const originalBackground = element.style.background;
                    const originalBorder = element.style.border;

                    // ä¸´æ—¶åº”ç”¨èƒŒæ™¯æ ·å¼ (çº¯ç±³ç™½ + è¾¹æ¡†) ä»¥ä¾¿æˆªå›¾
                    element.style.padding = '40px';
                    element.style.background = '#fdfcf8'; // åç±³ç™½
                    element.style.border = '12px solid #e0dfd8'; // å¤–ä¾§æ¡†çº¿

                    try {
                        const canvas = await html2canvas(element, {
                            scale: 2, // æé«˜æ¸…æ™°åº¦
                            useCORS: true, // å…è®¸è·¨åŸŸå›¾ç‰‡
                            allowTaint: true,
                            backgroundColor: null, // æˆ‘ä»¬å·²ç»è®¾ç½®äº† element background
                            ignoreElements: (element) => {
                                // å¿½ç•¥å¸¦æœ‰ data-html2canvas-ignore å±æ€§çš„å…ƒç´ 
                                return element.hasAttribute('data-html2canvas-ignore');
                            }
                        });

                        const link = document.createElement('a');
                        link.download = 'æˆ‘çš„å¹´åº¦ä¹¦å•.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    } catch (err) {
                        console.error('Export failed:', err);
                        alert('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡è·¨åŸŸé—®é¢˜ã€‚å»ºè®®ç›´æ¥æˆªå›¾ä¿å­˜ã€‚');
                    } finally {
                        // æ¢å¤æ ·å¼
                        element.style.padding = originalPadding;
                        element.style.background = originalBackground;
                        element.style.border = originalBorder;
                        exporting.value = false;
                    }
                };

                return {
                    query, loading, exporting, myBooks, searchResults, showModal,
                    searchBook, selectBook, handleFileUpload, removeBook,
                    handleImageError, exportImage,
                    username
                };
            }
        }).mount('#app');
    </script>
</body>

</html>