<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Reading Report 2025</title>
    <meta name="referrer" content="no-referrer">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app" class="main-container">
        <div class="input-group">
            <input class="search-input" v-model="query" @keyup.enter="searchBook" placeholder="ËæìÂÖ•‰π¶ÂêçÊêúÁ¥¢ÔºåÂõûËΩ¶Á°ÆËÆ§">
            <button class="btn-search" @click="searchBook" :disabled="loading">
                {{ loading ? '...' : 'üîç' }}
            </button>

            <button class="btn-upload">
                üìÇ
                <input type="file" accept="image/*" @change="handleFileUpload">
            </button>

            <button class="btn-export" @click="exportImage" :disabled="exporting">
                {{ exporting ? 'ÁîüÊàê‰∏≠...' : 'üñºÔ∏è' }}
            </button>

            <button class="btn-archive" @click="exportArchive" title="ÂØºÂá∫Â≠òÊ°£(JSON)">
                üíæ
            </button>

            <button class="btn-upload" title="ÂØºÂÖ•Â≠òÊ°£(JSON)">
                üì•
                <input type="file" accept="application/json" @change="importArchive" data-html2canvas-ignore>
            </button>
        </div>

        <!-- üì∏ Poster Area Start -->
        <div id="poster" class="poster">
            <header class="header">
                <div class="title-container">
                    <div class="title">2025 Reading Recap</div>
                    <div class="username-line">
                        <span class="at-name">@{{ username || 'YourName' }}</span>
                        <input type="text" v-model="username" placeholder="ËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó" class="name-input"
                            data-html2canvas-ignore>
                    </div>
                </div>
            </header>

            <div class="waterfall-wrap">
                <div class="waterfall">
                    <div v-for="(book, index) in myBooks" :key="book.id" class="book-card">
                        <!-- Delete button is hidden during export via CSS or logic if needed, but CSS hover handles it for UI -->
                        <div class="delete-btn" @click="removeBook(index)" data-html2canvas-ignore>√ó</div>
                        <img :src="book.cover" referrerPolicy="no-referrer" crossorigin="anonymous"
                            @error="handleImageError">
                        <!-- Book info deleted as per request -->
                    </div>
                </div>
            </div>

            <footer class="poster-footer">
                <div class="footer-left">2025 Reading Recap</div>
                <div class="footer-right">@{{ username || 'YourName' }} ¬∑ {{ myBooks.length }} books</div>
            </footer>
        </div>
        <!-- üì∏ Poster Area End -->

        <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ÈÄâÊã©ÁâàÊú¨</h3>
                    <button class="close-btn" @click="showModal = false">√ó</button>
                </div>
                <div class="search-results-list">
                    <div v-for="item in searchResults" :key="item.cover" class="result-item" @click="selectBook(item)">
                        <img :src="item.cover" referrerPolicy="no-referrer" @error="handleImageError">
                        <div class="result-title">{{ item.title }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="help-sidebar">
            <div class="help-trigger">
                <span class="icon">üí°</span>
                <span class="text">‰ΩøÁî®<br>ÊåáÂçó</span>
            </div>
            <div class="help-popover" v-if="helpData.length > 0">
                <div class="help-item" v-for="(item, index) in helpData" :key="index">
                    <div class="help-title">{{ item.title }}</div>
                    <div class="help-content">{{ item.content }}</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, nextTick, onMounted } = Vue;

        createApp({
            setup() {
                const query = ref('');
                const loading = ref(false);
                const exporting = ref(false);
                const myBooks = ref([]);
                const searchResults = ref([]);
                const showModal = ref(false);
                const username = ref(''); // Default empty or user can enter
                const helpData = ref([]);

                const WORKER_URL = 'https://falling-sun-969d.sparrowz0116.workers.dev/';

                const searchBook = async () => {
                    if (!query.value.trim()) return;
                    loading.value = true;

                    try {
                        const response = await fetch(`${WORKER_URL}?q=${encodeURIComponent(query.value)}`);
                        const data = await response.json();

                        if (data && data.length > 0) {
                            searchResults.value = data;
                            showModal.value = true;
                        } else {
                            alert('Ê≤°ÊúâÊâæÂà∞ËøôÊú¨‰π¶ÔºåËØïÁùÄÊç¢‰∏™ÂÖ≥ÈîÆËØçÔºàÂèØ‰ª•ËØï‰∏Ä‰∏ãÂâØÊ†áÈ¢òÊàñÂéü‰ΩúÂêçÔºâÔºåÊàñËÄÖÁõ¥Êé•‰∏ä‰º†ÂõæÁâáÂêßÔºÅ');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('ÊêúÁ¥¢Âá∫Èîô‰∫Ü');
                    } finally {
                        loading.value = false;
                    }
                };

                const selectBook = (bookItem) => {
                    myBooks.value.push({
                        id: Date.now(),
                        title: bookItem.title,
                        cover: bookItem.cover
                    });
                    showModal.value = false;
                    query.value = '';
                    searchResults.value = [];
                };

                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        myBooks.value.push({
                            id: Date.now(),
                            title: 'Ëá™ÂÆö‰πâ‰∏ä‰º†',
                            cover: e.target.result
                        });
                    };
                    reader.readAsDataURL(file);
                    event.target.value = '';
                };

                const removeBook = (index) => {
                    myBooks.value.splice(index, 1);
                };

                const handleImageError = (e) => {
                    const img = e.target;
                    const currentSrc = img.src;

                    if (currentSrc.includes('/l/public/')) {
                        img.src = currentSrc.replace('/l/public/', '/s/public/');
                    }
                    else {
                        img.src = 'https://via.placeholder.com/150x220?text=No+Cover';
                    }
                    img.onerror = null;
                };

                const initDragSort = async () => {
                    await nextTick();
                    const el = document.querySelector('.waterfall');
                    if (!el || el.__sortable_inited) return;

                    el.__sortable_inited = true;

                    new Sortable(el, {
                        animation: 150,
                        ghostClass: 'drag-ghost',
                        chosenClass: 'drag-chosen',
                        dragClass: 'drag-dragging',

                        // Âª∫ËÆÆÔºöÂè™ÂÖÅËÆ∏ÊãñÊãΩÂ∞ÅÈù¢ÂõæÁâáÔºåÈÅøÂÖçËØØÁÇπÂà†Èô§ÊåâÈíÆ
                        handle: 'img',
                        filter: '.delete-btn, input, button',
                        preventOnFilter: true,

                        onEnd: (evt) => {
                            if (evt.oldIndex === evt.newIndex) return;
                            const arr = myBooks.value;
                            const [moved] = arr.splice(evt.oldIndex, 1);
                            arr.splice(evt.newIndex, 0, moved);
                        }
                    });
                };

                // üü¢ ÂØºÂá∫ÂõæÁâáÂäüËÉΩ
                const exportImage = async () => {
                    if (myBooks.value.length === 0) {
                        alert('ÂÖàÂä†Âá†Êú¨‰π¶ÂÜçÂØºÂá∫Âêß~');
                        return;
                    }
                    exporting.value = true;

                    await nextTick();

                    // Ëé∑ÂèñË¶ÅÊà™ÂõæÁöÑÂå∫Âüü
                    const element = document.getElementById('poster');

                    // ‰øùÂ≠òÂéüÊúâÊ†∑Âºè
                    const originalPadding = element.style.padding;
                    const originalBackground = element.style.background;
                    const originalBorder = element.style.border;

                    // ‰∏¥Êó∂Â∫îÁî®ËÉåÊôØÊ†∑Âºè (Á∫ØÁ±≥ÁôΩ + ËæπÊ°Ü) ‰ª•‰æøÊà™Âõæ
                    element.style.padding = '40px';
                    element.style.background = '#fdfcf8'; // ÂÅèÁ±≥ÁôΩ
                    element.style.border = '12px solid #e0dfd8'; // Â§ñ‰æßÊ°ÜÁ∫ø

                    try {
                        const canvas = await html2canvas(element, {
                            scale: 2, // ÊèêÈ´òÊ∏ÖÊô∞Â∫¶
                            useCORS: true, // ÂÖÅËÆ∏Ë∑®ÂüüÂõæÁâá
                            allowTaint: true,
                            backgroundColor: null, // Êàë‰ª¨Â∑≤ÁªèËÆæÁΩÆ‰∫Ü element background
                            ignoreElements: (element) => {
                                // ÂøΩÁï•Â∏¶Êúâ data-html2canvas-ignore Â±ûÊÄßÁöÑÂÖÉÁ¥†
                                return element.hasAttribute('data-html2canvas-ignore');
                            }
                        });

                        const link = document.createElement('a');
                        link.download = 'ÊàëÁöÑÂπ¥Â∫¶‰π¶Âçï.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    } catch (err) {
                        console.error('Export failed:', err);
                        alert('ÂØºÂá∫ÂõæÁâáÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÂõæÁâáË∑®ÂüüÈóÆÈ¢ò„ÄÇÂª∫ËÆÆÁõ¥Êé•Êà™Âõæ‰øùÂ≠ò„ÄÇ');
                    } finally {
                        // ÊÅ¢Â§çÊ†∑Âºè
                        element.style.padding = originalPadding;
                        element.style.background = originalBackground;
                        element.style.border = originalBorder;
                        exporting.value = false;
                    }
                };

                const ARCHIVE_SCHEMA = 'moon-night-reading-archive';
                const ARCHIVE_VERSION = 1;

                const downloadJson = (obj, filename) => {
                    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                const exportArchive = () => {
                    const archive = {
                        schema: ARCHIVE_SCHEMA,
                        version: ARCHIVE_VERSION,
                        savedAt: new Date().toISOString(),
                        username: username.value || '',
                        books: myBooks.value.map((b, i) => ({
                            id: b.id,
                            title: b.title || '',
                            cover: b.cover,   // URL Êàñ dataURLÔºà‰Ω†‰∏ä‰º†Â∞ÅÈù¢Â∞±ÊòØ dataURLÔºâ
                            order: i
                        }))
                    };

                    const safeName = (username.value || 'YourName').replace(/[^\w-]+/g, '_');
                    downloadJson(archive, `reading-archive-2025-${safeName}.json`);
                };

                const importArchive = (event) => {
                    const file = event.target.files?.[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            const data = JSON.parse(String(reader.result || '{}'));

                            if (data.schema !== ARCHIVE_SCHEMA) {
                                alert('Ëøô‰∏çÊòØÊú¨È°πÁõÆÁöÑÂ≠òÊ°£Êñá‰ª∂Ôºàschema ‰∏çÂåπÈÖçÔºâ');
                                return;
                            }
                            if (!Array.isArray(data.books)) {
                                alert('Â≠òÊ°£Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºöbooks Áº∫Â§±');
                                return;
                            }

                            // ÊÅ¢Â§ç
                            username.value = data.username || '';
                            myBooks.value = data.books
                                .slice()
                                .sort((a, b) => (a.order ?? 0) - (b.order ?? 0))
                                .map(b => ({
                                    id: b.id ?? Date.now() + Math.random(),
                                    title: b.title || '',
                                    cover: b.cover || ''
                                }));

                            alert('ÂØºÂÖ•ÊàêÂäü ‚úÖ');
                        } catch (e) {
                            console.error(e);
                            alert('ÂØºÂÖ•Â§±Ë¥•ÔºöJSON Ëß£ÊûêÈîôËØØ');
                        }
                    };
                    reader.readAsText(file);

                    // ÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏Ä‰∏™Êñá‰ª∂‰πüËÉΩËß¶Âèë change
                    event.target.value = '';
                };

                onMounted(async () => {
                    try {
                        const response = await fetch('./help.json');
                        if (response.ok) {
                            helpData.value = await response.json();
                        }
                    } catch (error) {
                        console.warn('Help data load failed:', error);
                    }
                });

                initDragSort();
                return {
                    query, loading, exporting, myBooks, searchResults, showModal,
                    searchBook, selectBook, handleFileUpload, removeBook,
                    handleImageError, exportImage,
                    username,
                    helpData,
                    exportArchive,
                    importArchive
                };
            }
        }).mount('#app');
    </script>
</body>

</html>